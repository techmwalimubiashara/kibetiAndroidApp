name: Deploy Android to Internal Test

on:
  push:
    branches:
      - main
      - release

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'

      - name: Install Fastlane
        run: gem install fastlane

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks

      - name: Create service_account.json
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}' > service_account.json

      - name: Grant execute permission
        run: chmod +x android/gradlew

      - name: Auto Increment Version
        run: |
          cd android
          VERSION_CODE=$(grep versionCode app/build.gradle | awk '{print $2}')
          VERSION_NAME=$(grep versionName app/build.gradle | awk '{print $2}' | tr -d '"')

          NEW_VERSION_CODE=$((VERSION_CODE+1))

          IFS='.' read -ra ADDR <<< "$VERSION_NAME"
          PATCH=$((${ADDR[2]}+1))
          NEW_VERSION_NAME="${ADDR[0]}.${ADDR[1]}.$PATCH"

          sed -i "s/versionCode $VERSION_CODE/versionCode $NEW_VERSION_CODE/" app/build.gradle
          sed -i "s/versionName \"$VERSION_NAME\"/versionName \"$NEW_VERSION_NAME\"/" app/build.gradle

          echo "✅ Version updated to $NEW_VERSION_NAME ($NEW_VERSION_CODE)"

      - name: Build & Deploy
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd android
          fastlane internal

      - name: Send Email Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_ADDRESS }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ✅ Android App Deployed to Internal Test
          body: |
            Your Android app was successfully deployed to INTERNAL TESTING in Google Play.
            
            ✅ Version updated
            ✅ New build uploaded

            Time: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.sha }}
          to: ${{ secrets.EMAIL_ADDRESS }}
          from: GitHub Actions <${{ secrets.EMAIL_ADDRESS }}>
